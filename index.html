<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gantt de Validaci√≥n</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  :root {
    --navy:       #1a3a5c;
    --navy-dark:  #122840;
    --navy-light: #e8eef5;
    --bg:         #f2f4f7;
    --surface:    #ffffff;
    --surface2:   #f8f9fb;
    --border:     #dde1e8;
    --text:       #1e2530;
    --muted:      #6b7280;
    --faint:      #9aa3ae;
    --green:      #1e6e42;
    --green-bg:   #eaf4ee;
    --green-bd:   #a8d4b8;
    --orange:     #a04f00;
    --orange-bg:  #fdf1e6;
    --orange-bd:  #e8c8a0;
    --red:        #b91c1c;
    --red-bg:     #fee2e2;
    --red-bd:     #fecaca;
    --purple:     #8b5cf6;
    --purple-bg:  #ede9fe;
    --purple-bd:  #c4b5fd;
    --pdf-red:    #e74c3c;
    --pdf-blue:   #2980b9;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Barlow', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    position: sticky; top: 0; z-index: 200;
    background: var(--navy); border-bottom: 3px solid var(--navy-dark);
    padding: 0 36px; height: 52px;
    display: flex; align-items: center; justify-content: space-between; gap: 24px;
    box-shadow: 0 2px 14px rgba(0,0,0,0.15);
  }
  .header-left { display: flex; align-items: center; gap: 18px; }
  .logo-wrap {
    width: 34px;
    height: 34px;
    border-radius: 6px;
    background: white;
    border: 1px solid rgba(255,255,255,0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .logo-wrap img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
  .divider-v { width: 1px; height: 26px; background: rgba(255,255,255,0.18); }
  .header-title { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: #fff; }
  .header-sub { font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 1px; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .tl-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.5); white-space: nowrap; }

  .tl-wrap { position: relative; }
  .tl-input {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.25); color: #fff;
    font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 600;
    letter-spacing: 1px; text-transform: uppercase;
    padding: 6px 12px; border-radius: 6px; width: 200px; transition: border-color 0.2s, background 0.2s;
  }
  .tl-input::placeholder { color: rgba(255,255,255,0.35); font-weight: 400; font-size: 11px; text-transform: none; letter-spacing: 0; }
  .tl-input:focus { outline: none; border-color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.15); }
  .tl-input.valid { border-color: #4ade80; }

  .tl-dropdown {
    position: absolute; top: calc(100% + 6px); left: 0; right: 0;
    background: #fff; border: 1px solid var(--border); border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto;
    z-index: 999; display: none;
  }
  .tl-dropdown.show { display: block; }
  .tl-option { padding: 8px 12px; font-size: 12px; font-weight: 600; color: var(--navy); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.1s; }
  .tl-option:hover { background: var(--navy-light); }
  .tl-badge { font-size: 10px; background: var(--navy-light); color: var(--navy); border: 1px solid #c8d8e8; border-radius: 4px; padding: 1px 5px; font-weight: 700; }
  .tl-option.new-tl { color: var(--green); border-top: 1px solid var(--border); }
  .tl-option.new-tl .tl-badge { background: var(--green-bg); color: var(--green); border-color: var(--green-bd); }

  .upload-btn {
    display: flex; align-items: center; gap: 6px;
    background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.25); color: #fff;
    border-radius: 6px; padding: 6px 14px;
    font-family: 'Barlow', sans-serif; font-size: 12px; font-weight: 600;
    cursor: pointer; transition: background 0.18s; white-space: nowrap;
  }
  .upload-btn:hover:not(:disabled) { background: rgba(255,255,255,0.22); }
  .upload-btn:disabled { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); color: rgba(255,255,255,0.25); cursor: not-allowed; }
  #file-input { display: none; }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  main { padding: 16px 36px 0; flex: 1; min-width: 0; }

  .stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 14px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-top: 3px solid var(--border);
    border-radius: 10px; padding: 12px 18px; display: flex; align-items: center; gap: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04); animation: fadeUp 0.35s ease both;
  }
  .stat-card.total { border-top-color: var(--navy); }
  .stat-card.valid { border-top-color: var(--green); }
  .stat-card.pend  { border-top-color: var(--orange); }
  .stat-card.prog  { border-top-color: var(--purple); }
  .stat-icon { width: 34px; height: 34px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0; }
  .stat-card.total .stat-icon { background: var(--navy-light); }
  .stat-card.valid .stat-icon { background: var(--green-bg); }
  .stat-card.pend  .stat-icon { background: var(--orange-bg); }
  .stat-card.prog  .stat-icon { background: var(--purple-bg); }
  .stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
  .stat-value { font-family: 'Barlow Condensed', sans-serif; font-size: 24px; font-weight: 700; line-height: 1; color: var(--navy); }
  .stat-card.valid .stat-value { color: var(--green); }
  .stat-card.pend  .stat-value { color: var(--orange); }
  .stat-card.prog  .stat-value { color: var(--purple); }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .section-title { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); display: flex; align-items: center; gap: 10px; }
  .section-title::before { content: ''; display: block; width: 3px; height: 14px; background: var(--navy); border-radius: 2px; }

  .search-input { background: var(--surface); border: 1px solid var(--border); color: var(--text); font-family: 'Barlow', sans-serif; font-size: 13px; padding: 6px 12px; border-radius: 6px; width: 200px; transition: border-color 0.2s, box-shadow 0.2s; }
  .search-input:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px var(--navy-light); }
  .search-input::placeholder { color: var(--faint); }

  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: auto; box-shadow: 0 1px 6px rgba(0,0,0,0.05); max-height: calc(100vh - 220px); }
  table { width: 100%; border-collapse: collapse; min-width: 800px; }
  thead { background: var(--navy); position: sticky; top: 0; z-index: 10; }
  th { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,0.65); padding: 9px 16px; text-align: left; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.12s; }
  tbody tr:hover { background: var(--navy-light); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 9px 16px; font-size: 13px; vertical-align: middle; }

  .ruta-badge { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; color: var(--navy); background: var(--navy-light); border: 1px solid #c8d8e8; border-radius: 5px; padding: 2px 9px; display: inline-block; letter-spacing: 0.8px; }
  .viaje-text { color: var(--muted); font-size: 12px; font-weight: 500; margin-left: 5px; }
  .action-icons {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    margin-left: 10px;
  }
  .click-hint { font-size: 10px; color: var(--faint); cursor: pointer; }
  .click-hint:hover { color: var(--navy); text-decoration: underline; }
  .pdf-icon {
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.15s;
  }
  .pdf-icon:hover {
    transform: scale(1.15);
  }
  .pdf-icon.red {
    color: var(--pdf-red);
  }
  .pdf-icon.blue {
    color: var(--pdf-blue);
  }

  .progress-cell { min-width: 150px; }
  .progress-wrap { display: flex; align-items: center; gap: 8px; }
  .progress-bar-bg { flex: 1; height: 5px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
  .progress-pct { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; min-width: 34px; text-align: right; }

  .chip { display: inline-block; font-size: 10px; font-weight: 600; letter-spacing: 0.3px; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
  .chip.pendiente { background: var(--orange-bg); color: var(--orange); border: 1px solid var(--orange-bd); }
  .chip.concluido { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-bd); }
  .chip.faltante { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-bd); }
  .chip.faltante-confirmado { background: var(--purple-bg); color: var(--purple); border: 1px solid var(--purple-bd); }
  .chip.na { background: var(--bg); color: var(--faint); border: 1px solid var(--border); }

  .delete-btn {
    background: var(--red-bg);
    color: var(--red);
    border: 1px solid var(--red-bd);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .delete-btn:hover {
    background: var(--red);
    color: white;
  }

  .empty-state { padding: 60px 20px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .empty-icon { width: 52px; height: 52px; border: 2px dashed var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: var(--faint); }
  .empty-title { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .empty-sub { font-size: 12px; color: var(--faint); }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.45);
    z-index: 500; display: none; align-items: center; justify-content: center;
    padding: 20px; backdrop-filter: blur(3px);
  }
  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--surface); border-radius: 14px;
    width: 100%; max-width: 1100px; max-height: 88vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn { from { opacity: 0; transform: translateY(20px) scale(0.97); } to { opacity: 1; transform: none; } }

  .modal-header {
    background: var(--navy); border-radius: 14px 14px 0 0;
    padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .modal-title { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 1px; }
  .modal-meta { font-size: 11px; color: rgba(255,255,255,0.55); margin-top: 2px; }
  .modal-close { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; width: 28px; height: 28px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.15s; flex-shrink: 0; }
  .modal-close:hover { background: rgba(255,255,255,0.25); }

  .modal-body { overflow-y: auto; flex: 1; padding: 16px 20px; }

  /* Info de validaci√≥n en modal */
  .validacion-info {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
  }
  .info-item {
    display: flex;
    flex-direction: column;
  }
  .info-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
  }
  .info-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--navy);
  }

  /* Almacen section inside modal */
  .alm-section { margin-bottom: 18px; }
  .alm-section:last-child { margin-bottom: 0; }

  .alm-header {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px 8px 0 0; padding: 8px 14px; margin-bottom: 0;
  }
  .alm-name { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; color: var(--navy); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
  .alm-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--navy); flex-shrink: 0; }
  .alm-count { font-size: 11px; color: var(--muted); font-weight: 500; }

  .alm-table-wrap { border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; overflow-x: auto; }
  .alm-table { width: 100%; border-collapse: collapse; min-width: 700px; }
  .alm-table th { 
    background: #1a3a5c; 
    color: white;
    font-family: 'Barlow Condensed', sans-serif; 
    font-size: 11px; 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 1.2px; 
    padding: 8px 12px; 
    text-align: left; 
    border-bottom: 1px solid var(--border); 
  }
  .alm-table td { padding: 7px 12px; font-size: 12.5px; border-bottom: 1px solid #f0f2f5; vertical-align: middle; }
  .alm-table tr:last-child td { border-bottom: none; }
  .alm-table tr:hover td { background: var(--surface2); }

  .codigo-badge { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 13px; color: var(--navy); }
  .desc-text { color: var(--text); max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .udm-text { color: var(--muted); font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .sdo-text { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 14px; color: var(--text); }

  /* Status in modal */
  .status-badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
    padding: 4px 12px;
    border-radius: 20px;
    text-transform: uppercase;
    min-width: 90px;
    text-align: center;
  }
  .status-badge.pendiente {
    background: var(--orange-bg);
    color: var(--orange);
    border: 1px solid var(--orange-bd);
  }
  .status-badge.concluido {
    background: var(--green-bg);
    color: var(--green);
    border: 1px solid var(--green-bd);
  }
  .status-badge.faltante {
    background: var(--red-bg);
    color: var(--red);
    border: 1px solid var(--red-bd);
  }
  .status-badge.faltante-confirmado {
    background: var(--purple-bg);
    color: var(--purple);
    border: 1px solid var(--purple-bd);
  }

  .btn-confirmar {
    background: var(--purple);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    margin-left: 8px;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .btn-confirmar:hover {
    background: #6d28d9;
  }

  .modal-footer {
    border-top: 1px solid var(--border); padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0; background: var(--surface2); border-radius: 0 0 14px 14px;
  }
  .modal-pct-wrap { display: flex; align-items: center; gap: 10px; }
  .modal-pct-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
  .modal-pct-bar-bg { width: 160px; height: 6px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .modal-pct-bar { height: 100%; background: var(--purple); border-radius: 4px; transition: width 0.4s ease; }
  .modal-pct-val { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; color: var(--navy); }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  footer { background: var(--navy-dark); border-top: 1px solid rgba(255,255,255,0.08); padding: 7px 36px; display: flex; align-items: center; justify-content: center; gap: 6px; flex-shrink: 0; }
  .footer-text { font-size: 11px; color: rgba(255,255,255,0.35); font-family: 'Barlow', sans-serif; letter-spacing: 0.4px; }
  .footer-sep { color: rgba(255,255,255,0.18); font-size: 11px; }

  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--navy); color: white; padding: 10px 18px; border-radius: 8px; font-size: 12px; z-index: 9999; animation: slideIn 0.3s ease; box-shadow: 0 6px 24px rgba(0,0,0,0.2); }

  @keyframes slideIn { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes fadeUp  { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  @media (max-width: 1100px) { .tl-input { width: 160px; } }
  @media (max-width: 900px) {
    .stats-row { grid-template-columns: repeat(2,1fr); }
    header { padding: 0 16px; gap: 10px; }
    main { padding: 12px 16px 0; }
    footer { padding: 7px 16px; }
    .tl-label { display: none; }
    .tl-input { width: 140px; }
    .header-title { font-size: 15px; }
    .header-sub { display: none; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <div class="logo-wrap">
      <img src="logo.png" alt="Logo" onerror="this.parentElement.innerHTML='<span style=&quot;font-family:Barlow Condensed,sans-serif;font-weight:700;font-size:14px;color:white;&quot;>GV</span>'">
    </div>
    <div class="divider-v"></div>
    <div>
      <div class="header-title">Gantt de Validaci√≥n</div>
      <div class="header-sub">Control de rutas y almacenes</div>
    </div>
  </div>
  <div class="header-right">
    <span class="tl-label">Team Leader</span>
    <div class="tl-wrap">
      <input type="text" id="tlInput" class="tl-input" placeholder="Escribe un nombre..." maxlength="60" autocomplete="off">
      <div class="tl-dropdown" id="tlDropdown"></div>
    </div>
    <button class="upload-btn" id="uploadBtn" disabled>‚¨Ü Cargar XLSX</button>
    <input type="file" id="file-input" accept=".xlsx,.xls">
  </div>
</header>

<!-- MAIN -->
<main>
  <div class="stats-row">
    <div class="stat-card total">
      <div class="stat-icon">üìã</div>
      <div><div class="stat-label">Rutas Totales</div><div class="stat-value" id="statTotal">0</div></div>
    </div>
    <div class="stat-card valid">
      <div class="stat-icon">‚úì</div>
      <div><div class="stat-label">100% Validadas</div><div class="stat-value" id="statValidadas">0</div></div>
    </div>
    <div class="stat-card pend">
      <div class="stat-icon">‚è≥</div>
      <div><div class="stat-label">Pendientes</div><div class="stat-value" id="statPendientes">0</div></div>
    </div>
    <div class="stat-card prog">
      <div class="stat-icon">üìà</div>
      <div><div class="stat-label">Avance Global</div><div class="stat-value" id="statProgreso">0%</div></div>
    </div>
  </div>

  <div class="section-header">
    <div class="section-title">Seguimiento de Rutas</div>
    <input class="search-input" type="text" id="searchInput" placeholder="Buscar ruta o viaje...">
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ruta / Viaje</th>
          <th class="progress-cell">% Validaci√≥n</th>
          <th>Seco</th>
          <th>Refrigerado</th>
          <th>Congelado</th>
          <th>Cr√≠tico</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div id="emptyState" class="empty-state">
      <div class="empty-icon">üìã</div>
      <div class="empty-title">Sin datos cargados</div>
      <div class="empty-sub">Ingresa un Team Leader y carga un archivo XLSX</div>
    </div>
  </div>
</main>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modalTitle">Detalle de Ruta</div>
        <div class="modal-meta" id="modalMeta"></div>
      </div>
      <button class="modal-close" id="modalClose">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <div class="modal-pct-wrap">
        <span class="modal-pct-label">Avance</span>
        <div class="modal-pct-bar-bg"><div class="modal-pct-bar" id="modalPctBar" style="width:0%"></div></div>
        <span class="modal-pct-val" id="modalPctVal">0%</span>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <span class="footer-text">¬© 2026</span>
  <span class="footer-sep">¬∑</span>
  <span class="footer-text">E.Lugo</span>
  <span class="footer-sep">¬∑</span>
  <span class="footer-text">Todos los derechos reservados</span>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, getDocs,
    onSnapshot, writeBatch, query, orderBy, where, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB1APqzO0tsh1Ow58-e8VBYeTYbdmLxsNI",
    authDomain: "validacion-2026.firebaseapp.com",
    projectId: "validacion-2026",
    storageBucket: "validacion-2026.firebasestorage.app",
    messagingSenderId: "9004667623",
    appId: "1:9004667623:web:5331db7cda0b94deacc842"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let allRoutes = [];
  let allRawItems = [];
  let itemStatus = {};
  let routeAlmStatus = {};
  let teamLeaderName = '';
  let knownTLs = [];
  let currentModalKey = null;
  let sesionesPorRuta = {}; // Cache de sesiones por ruta

  // ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const tlInput = document.getElementById('tlInput');
  const tlDropdown = document.getElementById('tlDropdown');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('file-input');
  const searchInput = document.getElementById('searchInput');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalClose = document.getElementById('modalClose');

  // ‚îÄ‚îÄ Load known TLs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadKnownTLs() {
    try {
      const snap = await getDocs(collection(db, 'team_leaders'));
      knownTLs = snap.docs.map(d => d.data().nombre).filter(Boolean);
    } catch (e) { console.warn('TLs:', e); }
  }

  // ‚îÄ‚îÄ TL Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  tlInput.addEventListener('input', () => {
    const pos = tlInput.selectionStart;
    tlInput.value = tlInput.value.toUpperCase();
    tlInput.setSelectionRange(pos, pos);
    teamLeaderName = tlInput.value.trim();
    updateUploadBtn();
    showSuggestions();
  });

  tlInput.addEventListener('keydown', e => {
    if (e.key === 'Escape') hideSuggestions();
    if (e.key === 'Enter' && teamLeaderName) { hideSuggestions(); tlInput.blur(); }
  });

  document.addEventListener('click', e => {
    if (!tlInput.closest('.tl-wrap').contains(e.target)) hideSuggestions();
  });

  function updateUploadBtn() {
    const ok = teamLeaderName.length >= 2;
    uploadBtn.disabled = !ok;
    tlInput.classList.toggle('valid', ok);
  }

  function showSuggestions() {
    const q = teamLeaderName;
    if (!q) { hideSuggestions(); return; }
    const matches = knownTLs.filter(tl => tl.includes(q) && tl !== q);
    const exact = knownTLs.includes(q);
    let html = matches.map(tl => `<div class="tl-option" data-name="${tl}"><span class="tl-badge">REGISTRADO</span>${tl}</div>`).join('');
    if (!exact) html += `<div class="tl-option new-tl" data-name="${q}"><span class="tl-badge">NUEVO</span>${q}</div>`;
    if (!html) { hideSuggestions(); return; }
    tlDropdown.innerHTML = html;
    tlDropdown.classList.add('show');
    tlDropdown.querySelectorAll('.tl-option').forEach(opt => {
      opt.addEventListener('click', () => {
        tlInput.value = opt.dataset.name;
        teamLeaderName = opt.dataset.name;
        updateUploadBtn();
        hideSuggestions();
      });
    });
  }
  function hideSuggestions() { tlDropdown.classList.remove('show'); }

  // ‚îÄ‚îÄ File upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  uploadBtn.addEventListener('click', () => {
    if (teamLeaderName.length < 2) { showToast('‚ö† Ingresa el nombre del Team Leader'); return; }
    fileInput.click();
  });

  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
      processData(rows);
    };
    reader.readAsArrayBuffer(file);
    e.target.value = '';
  });

  // ‚îÄ‚îÄ Column helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function normKey(s) {
    return s.trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^A-Z0-9]/g, '');
  }
  function getCol(row, ...names) {
    const map = {};
    Object.keys(row).forEach(k => { map[normKey(k)] = row[k]; });
    for (const n of names) {
      const v = map[normKey(n)];
      if (v !== undefined && v !== null && v !== '') return v.toString().trim();
    }
    return '';
  }

  // ‚îÄ‚îÄ Process XLSX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function processData(rows) {
    if (!rows.length) { showToast('‚ö† Archivo vac√≠o'); return; }

    allRawItems = [];
    const routeMap = {};

    rows.forEach((row, idx) => {
      const ruta = getCol(row, 'RUTA').toUpperCase();
      const viaje = getCol(row, 'VIAJE');
      const codigo = getCol(row, 'CODIGO', 'C√ìDIGO');
      const desc = getCol(row, 'DESCRIPCCION', 'DESCRIPCION', 'DESCRIPCI√ìN');
      const udm = getCol(row, 'UDM');
      const sdo = getCol(row, 'SDO');
      const alm = getCol(row, 'ALMACEN', 'ALMAC√âN').toUpperCase();
      if (!ruta) return;

      const itemId = `${ruta}__${viaje}__${alm}__${codigo}__${idx}`.replace(/[^a-zA-Z0-9_-]/g, '_');

      allRawItems.push({ itemId, ruta, viaje, codigo, desc, udm, sdo, alm });
      if (!(itemId in itemStatus)) itemStatus[itemId] = 'pendiente';

      const key = `${ruta}||${viaje}`;
      if (!routeMap[key]) routeMap[key] = { ruta, viaje, almacenes: new Set() };
      if (alm) routeMap[key].almacenes.add(alm);
    });

    allRoutes = Object.values(routeMap).map(r => ({ ...r, almacenes: [...r.almacenes] }));
    recalcRouteAlmStatus();
    renderTable();
    saveAllToFirestore();
  }

  // ‚îÄ‚îÄ Recalc almacen-level status from item statuses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function recalcRouteAlmStatus() {
    routeAlmStatus = {};
    allRoutes.forEach(r => {
      r.almacenes.forEach(alm => {
        const items = allRawItems.filter(it => it.ruta === r.ruta && it.viaje === r.viaje && it.alm === alm);
        const allDone = items.length > 0 && items.every(it => 
          itemStatus[it.itemId] === 'concluido' || 
          itemStatus[it.itemId] === 'faltante-confirmado'
        );
        const hasFaltantes = items.some(it => itemStatus[it.itemId] === 'faltante');
        const hasFaltantesConfirmados = items.some(it => itemStatus[it.itemId] === 'faltante-confirmado');

        if (allDone) {
          routeAlmStatus[`${r.ruta}||${r.viaje}||${alm}`] = 'concluido';
        } else if (hasFaltantes) {
          routeAlmStatus[`${r.ruta}||${r.viaje}||${alm}`] = 'faltante';
        } else if (hasFaltantesConfirmados) {
          routeAlmStatus[`${r.ruta}||${r.viaje}||${alm}`] = 'faltante-confirmado';
        } else {
          routeAlmStatus[`${r.ruta}||${r.viaje}||${alm}`] = 'pendiente';
        }
      });
    });
  }

  // ‚îÄ‚îÄ Save everything to Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function saveAllToFirestore() {
    try {
      showToast('‚è≥ Guardando en Firebase...');

      await setDoc(doc(db, 'team_leaders', teamLeaderName), {
        nombre: teamLeaderName, actualizadoEn: new Date().toISOString()
      }, { merge: true });

      const CHUNK = 400;
      for (let i = 0; i < allRoutes.length; i += CHUNK) {
        const batch = writeBatch(db);
        allRoutes.slice(i, i + CHUNK).forEach(r => {
          const docId = `${r.ruta}__${r.viaje}`.replace(/[^a-zA-Z0-9_-]/g, '_');
          batch.set(doc(db, 'rutas', docId), {
            ruta: r.ruta, viaje: r.viaje, almacenes: r.almacenes,
            teamLeader: teamLeaderName, cargadoEn: new Date().toISOString()
          }, { merge: true });
        });
        await batch.commit();
      }

      for (let i = 0; i < allRawItems.length; i += CHUNK) {
        const batch = writeBatch(db);
        allRawItems.slice(i, i + CHUNK).forEach(it => {
          batch.set(doc(db, 'items', it.itemId), {
            ruta: it.ruta, viaje: it.viaje, codigo: it.codigo,
            descripcion: it.desc, udm: it.udm, sdo: it.sdo,
            almacen: it.alm, teamLeader: teamLeaderName,
            estatus: itemStatus[it.itemId] || 'pendiente',
            cargadoEn: new Date().toISOString()
          }, { merge: true });
        });
        await batch.commit();
      }

      if (!knownTLs.includes(teamLeaderName)) knownTLs.push(teamLeaderName);
      showToast(`‚úÖ ${allRawItems.length} √≠tems guardados en Firebase`);
    } catch (err) {
      console.error(err);
      showToast('‚ùå Error al guardar en Firebase');
    }
  }

  // ‚îÄ‚îÄ Delete route and all its items ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function deleteRoute(ruta, viaje) {
    if (!confirm(`¬øEst√°s seguro de eliminar la ruta ${ruta} (Viaje: ${viaje})?\nSe eliminar√°n todos los productos asociados.`)) {
      return;
    }

    try {
      showToast('‚è≥ Eliminando ruta...');

      const itemsToDelete = allRawItems.filter(it => it.ruta === ruta && it.viaje === viaje);

      const CHUNK = 400;
      for (let i = 0; i < itemsToDelete.length; i += CHUNK) {
        const batch = writeBatch(db);
        itemsToDelete.slice(i, i + CHUNK).forEach(it => {
          const docRef = doc(db, 'items', it.itemId);
          batch.delete(docRef);
        });
        await batch.commit();
      }

      const routeDocId = `${ruta}__${viaje}`.replace(/[^a-zA-Z0-9_-]/g, '_');
      await deleteDoc(doc(db, 'rutas', routeDocId));

      const sesionesQuery = query(
        collection(db, 'sesiones_validacion'),
        where('ruta', '==', ruta),
        where('viaje', '==', viaje)
      );
      const sesionesSnap = await getDocs(sesionesQuery);
      for (let i = 0; i < sesionesSnap.docs.length; i += CHUNK) {
        const batch = writeBatch(db);
        sesionesSnap.docs.slice(i, i + CHUNK).forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
      }

      allRoutes = allRoutes.filter(r => !(r.ruta === ruta && r.viaje === viaje));
      allRawItems = allRawItems.filter(it => !(it.ruta === ruta && it.viaje === viaje));

      itemsToDelete.forEach(it => {
        delete itemStatus[it.itemId];
      });

      recalcRouteAlmStatus();
      renderTable();

      showToast('‚úÖ Ruta eliminada correctamente');
    } catch (error) {
      console.error('Error deleting route:', error);
      showToast('‚ùå Error al eliminar la ruta');
    }
  }

  // ‚îÄ‚îÄ Funci√≥n para confirmar faltante ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function confirmarFaltante(itemId) {
    try {
      await setDoc(doc(db, 'items', itemId), {
        estatus: 'faltante-confirmado'
      }, { merge: true });
      showToast('‚úÖ Faltante confirmado');
    } catch (error) {
      console.error('Error al confirmar faltante:', error);
      showToast('‚ùå Error al confirmar');
    }
  }

  // ‚îÄ‚îÄ Funci√≥n para cargar sesiones de una ruta ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function cargarSesionesRuta(ruta, viaje) {
    const key = `${ruta}||${viaje}`;
    if (sesionesPorRuta[key]) return sesionesPorRuta[key];

    try {
      const sesionesQuery = query(
        collection(db, 'sesiones_validacion'),
        where('ruta', '==', ruta),
        where('viaje', '==', viaje)
      );
      const sesionesSnap = await getDocs(sesionesQuery);
      const sesiones = sesionesSnap.docs.map(d => d.data());
      
      // Organizar por almac√©n (m√°s reciente)
      const sesionPorAlmacen = {};
      sesiones.forEach(s => {
        const almacen = s.almacen;
        if (!sesionPorAlmacen[almacen] || new Date(s.inicio) > new Date(sesionPorAlmacen[almacen].inicio)) {
          sesionPorAlmacen[almacen] = s;
        }
      });

      sesionesPorRuta[key] = { todas: sesiones, porAlmacen: sesionPorAlmacen };
      return sesionesPorRuta[key];
    } catch (error) {
      console.error('Error cargando sesiones:', error);
      return { todas: [], porAlmacen: {} };
    }
  }

  // ‚îÄ‚îÄ Funci√≥n para calcular tiempo transcurrido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcularTiempoTranscurrido(inicio, fin) {
    if (!inicio || !fin) return 'N/A';
    const diff = Math.floor((new Date(fin) - new Date(inicio)) / 1000);
    const horas = Math.floor(diff / 3600).toString().padStart(2, '0');
    const minutos = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
    const segundos = (diff % 60).toString().padStart(2, '0');
    return `${horas}:${minutos}:${segundos}`;
  }

  // ‚îÄ‚îÄ Funci√≥n para generar vista previa de productos (nueva pesta√±a) ‚îÄ‚îÄ‚îÄ
async function generarPDFProductos(ruta, viaje) {
  showToast('‚è≥ Generando vista previa...');
  
  try {
    const items = allRawItems.filter(it => it.ruta === ruta && it.viaje === viaje);
    
    const { todas: sesiones } = await cargarSesionesRuta(ruta, viaje);

    const almacenes = {
      SECO: items.filter(i => i.alm === 'SECO'),
      REFRIGERADO: items.filter(i => i.alm === 'REFRIGERADO'),
      CONGELADO: items.filter(i => i.alm === 'FRIO'),
      CRITICO: items.filter(i => i.alm === 'CRITICO')
    };

    const totalItems = items.length;
    const concluidos = items.filter(i => 
      itemStatus[i.itemId] === 'concluido' || 
      itemStatus[i.itemId] === 'faltante-confirmado'
    ).length;

    const fecha = new Date().toLocaleDateString('es-MX');
    const hora = new Date().toLocaleTimeString('es-MX');

    // Generar HTML completo con estilos para impresi√≥n
    const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Lista de Productos - Ruta ${ruta}</title>
        <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: 'Barlow', Arial, sans-serif; 
            background: white; 
            color: #1e2530; 
            padding: 20px;
            font-size: 10px;
          }
          .container {
            max-width: 1100px;
            margin: 0 auto;
          }
          h1 {
            font-family: 'Barlow Condensed', sans-serif;
            color: #1a3a5c;
            font-size: 22px;
            text-align: center;
            margin-bottom: 5px;
          }
          h2 {
            font-family: 'Barlow Condensed', sans-serif;
            color: #6b7280;
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 400;
          }
          .header-line {
            border-bottom: 2px solid #1a3a5c;
            margin-bottom: 15px;
          }
          .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background: #f8f9fb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
          }
          .alm-section {
            margin-bottom: 20px;
            page-break-inside: avoid;
          }
          .alm-header {
            background: #1a3a5c;
            color: white;
            padding: 6px 10px;
            border-radius: 4px 4px 0 0;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
          }
          table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            border: 1px solid #dde1e8;
            font-size: 9px;
          }
          colgroup col:nth-child(1) { width: 120px; }
          colgroup col:nth-child(2) { width: 400px; }
          colgroup col:nth-child(3) { width: 60px; }
          colgroup col:nth-child(4) { width: 60px; }
          colgroup col:nth-child(5) { width: 160px; }
          th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
            padding: 5px;
            text-align: left;
            border: 1px solid #1a3a5c;
          }
          td {
            padding: 4px 5px;
            border: 1px solid #dde1e8;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
          .text-right { text-align: right; }
          .status-pendiente { background-color: #fdf1e6; }
          .status-concluido { background-color: #eaf4ee; }
          .status-faltante { background-color: #fee2e2; }
          .status-faltante-confirmado { background-color: #ede9fe; }
          .sin-productos {
            padding: 20px;
            text-align: center;
            color: #999;
            border: 1px solid #dde1e8;
          }
          .sesiones-box {
            margin-top: 20px;
            background: #f8f9fb;
            padding: 10px;
            border-radius: 4px;
            font-size: 9px;
          }
          .sesion-item {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #dde1e8;
          }
          .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 8px;
            color: #9aa3ae;
          }
          @media print {
            body { padding: 10px; }
            .no-print { display: none; }
            button { display: none; }
          }
          .print-button {
            background: #1a3a5c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-bottom: 15px;
          }
          .print-button:hover {
            background: #122840;
          }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="no-print" style="text-align: right; margin-bottom: 10px;">
            <button class="print-button" onclick="window.print()">üñ®Ô∏è Imprimir</button>
          </div>
          
          <h1>LISTA DE PRODUCTOS POR ALMAC√âN</h1>
          <h2>Ruta: ${ruta} | Viaje: ${viaje}</h2>
          <div class="header-line"></div>
          
          <div class="stats-grid">
            <div><strong>Fecha:</strong> ${fecha}</div>
            <div><strong>Hora:</strong> ${hora}</div>
            <div><strong>Total:</strong> ${totalItems}</div>
            <div><strong>Concluidos:</strong> ${concluidos} (${totalItems ? Math.round(concluidos/totalItems*100) : 0}%)</div>
          </div>

          <!-- SECO -->
          <div class="alm-section">
            <div class="alm-header">
              <span>SECO</span>
              <span>${almacenes.SECO.filter(i => itemStatus[i.itemId] === 'concluido' || itemStatus[i.itemId] === 'faltante-confirmado').length}/${almacenes.SECO.length} concluidos</span>
            </div>
            <table>
              <colgroup>
                <col><col><col><col><col>
              </colgroup>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th>UDM</th>
                  <th>SDO</th>
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody>
                ${almacenes.SECO.map(item => {
                  const estatus = itemStatus[item.itemId] || 'pendiente';
                  let textoEstatus = estatus;
                  if (estatus === 'faltante-confirmado') textoEstatus = 'faltante confirmado';
                  
                  let statusClass = '';
                  if (estatus === 'concluido') statusClass = 'status-concluido';
                  else if (estatus === 'faltante') statusClass = 'status-faltante';
                  else if (estatus === 'faltante-confirmado') statusClass = 'status-faltante-confirmado';
                  else statusClass = 'status-pendiente';
                  
                  return `
                    <tr class="${statusClass}">
                      <td style="font-weight: 600;">${item.codigo}</td>
                      <td>${item.desc || ''}</td>
                      <td>${item.udm || 'N/A'}</td>
                      <td class="text-right">${item.sdo || 0}</td>
                      <td style="text-transform: uppercase;">${textoEstatus}</td>
                    </tr>
                  `;
                }).join('')}
                ${almacenes.SECO.length === 0 ? `
                  <tr>
                    <td colspan="5" class="sin-productos">Sin productos</td>
                  </tr>
                ` : ''}
              </tbody>
            </table>
          </div>

          <!-- REFRIGERADO -->
          <div class="alm-section">
            <div class="alm-header">
              <span>REFRIGERADO</span>
              <span>${almacenes.REFRIGERADO.filter(i => itemStatus[i.itemId] === 'concluido' || itemStatus[i.itemId] === 'faltante-confirmado').length}/${almacenes.REFRIGERADO.length} concluidos</span>
            </div>
            <table>
              <colgroup>
                <col><col><col><col><col>
              </colgroup>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th>UDM</th>
                  <th>SDO</th>
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody>
                ${almacenes.REFRIGERADO.map(item => {
                  const estatus = itemStatus[item.itemId] || 'pendiente';
                  let textoEstatus = estatus;
                  if (estatus === 'faltante-confirmado') textoEstatus = 'faltante confirmado';
                  
                  let statusClass = '';
                  if (estatus === 'concluido') statusClass = 'status-concluido';
                  else if (estatus === 'faltante') statusClass = 'status-faltante';
                  else if (estatus === 'faltante-confirmado') statusClass = 'status-faltante-confirmado';
                  else statusClass = 'status-pendiente';
                  
                  return `
                    <tr class="${statusClass}">
                      <td style="font-weight: 600;">${item.codigo}</td>
                      <td>${item.desc || ''}</td>
                      <td>${item.udm || 'N/A'}</td>
                      <td class="text-right">${item.sdo || 0}</td>
                      <td style="text-transform: uppercase;">${textoEstatus}</td>
                    </tr>
                  `;
                }).join('')}
                ${almacenes.REFRIGERADO.length === 0 ? `
                  <tr>
                    <td colspan="5" class="sin-productos">Sin productos</td>
                  </tr>
                ` : ''}
              </tbody>
            </table>
          </div>

          <!-- CONGELADO -->
          <div class="alm-section">
            <div class="alm-header">
              <span>CONGELADO</span>
              <span>${almacenes.CONGELADO.filter(i => itemStatus[i.itemId] === 'concluido' || itemStatus[i.itemId] === 'faltante-confirmado').length}/${almacenes.CONGELADO.length} concluidos</span>
            </div>
            <table>
              <colgroup>
                <col><col><col><col><col>
              </colgroup>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th>UDM</th>
                  <th>SDO</th>
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody>
                ${almacenes.CONGELADO.map(item => {
                  const estatus = itemStatus[item.itemId] || 'pendiente';
                  let textoEstatus = estatus;
                  if (estatus === 'faltante-confirmado') textoEstatus = 'faltante confirmado';
                  
                  let statusClass = '';
                  if (estatus === 'concluido') statusClass = 'status-concluido';
                  else if (estatus === 'faltante') statusClass = 'status-faltante';
                  else if (estatus === 'faltante-confirmado') statusClass = 'status-faltante-confirmado';
                  else statusClass = 'status-pendiente';
                  
                  return `
                    <tr class="${statusClass}">
                      <td style="font-weight: 600;">${item.codigo}</td>
                      <td>${item.desc || ''}</td>
                      <td>${item.udm || 'N/A'}</td>
                      <td class="text-right">${item.sdo || 0}</td>
                      <td style="text-transform: uppercase;">${textoEstatus}</td>
                    </tr>
                  `;
                }).join('')}
                ${almacenes.CONGELADO.length === 0 ? `
                  <tr>
                    <td colspan="5" class="sin-productos">Sin productos</td>
                  </tr>
                ` : ''}
              </tbody>
            </table>
          </div>

          <!-- CR√çTICO -->
          <div class="alm-section">
            <div class="alm-header">
              <span>CR√çTICO</span>
              <span>${almacenes.CRITICO.filter(i => itemStatus[i.itemId] === 'concluido' || itemStatus[i.itemId] === 'faltante-confirmado').length}/${almacenes.CRITICO.length} concluidos</span>
            </div>
            <table>
              <colgroup>
                <col><col><col><col><col>
              </colgroup>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th>UDM</th>
                  <th>SDO</th>
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody>
                ${almacenes.CRITICO.map(item => {
                  const estatus = itemStatus[item.itemId] || 'pendiente';
                  let textoEstatus = estatus;
                  if (estatus === 'faltante-confirmado') textoEstatus = 'faltante confirmado';
                  
                  let statusClass = '';
                  if (estatus === 'concluido') statusClass = 'status-concluido';
                  else if (estatus === 'faltante') statusClass = 'status-faltante';
                  else if (estatus === 'faltante-confirmado') statusClass = 'status-faltante-confirmado';
                  else statusClass = 'status-pendiente';
                  
                  return `
                    <tr class="${statusClass}">
                      <td style="font-weight: 600;">${item.codigo}</td>
                      <td>${item.desc || ''}</td>
                      <td>${item.udm || 'N/A'}</td>
                      <td class="text-right">${item.sdo || 0}</td>
                      <td style="text-transform: uppercase;">${textoEstatus}</td>
                    </tr>
                  `;
                }).join('')}
                ${almacenes.CRITICO.length === 0 ? `
                  <tr>
                    <td colspan="5" class="sin-productos">Sin productos</td>
                  </tr>
                ` : ''}
              </tbody>
            </table>
          </div>

          ${sesiones.length > 0 ? `
            <div class="sesiones-box">
              <h3 style="font-family: 'Barlow Condensed', sans-serif; color: #1a3a5c; margin: 0 0 10px; font-size: 14px;">Sesiones de Validaci√≥n</h3>
              ${sesiones.map(s => `
                <div class="sesion-item">
                  <div><strong>Validador:</strong> ${s.validador || 'N/A'}</div>
                  <div><strong>Almac√©n:</strong> ${s.almacen === 'FRIO' ? 'CONGELADO' : s.almacen}</div>
                  <div><strong>Inicio:</strong> ${s.inicio ? new Date(s.inicio).toLocaleString() : 'N/A'}</div>
                  <div><strong>Fin:</strong> ${s.fin ? new Date(s.fin).toLocaleString() : 'N/A'}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}

          <div class="footer">
            Documento generado el ${fecha} a las ${hora}
          </div>
        </div>
      </body>
      </html>
    `;

    // Abrir nueva pesta√±a con el contenido
    const ventana = window.open('', '_blank');
    ventana.document.write(htmlContent);
    ventana.document.close();
    
    showToast('‚úÖ Vista previa abierta en nueva pesta√±a');
  } catch (error) {
    console.error('Error generando vista previa:', error);
    showToast('‚ùå Error al generar vista previa');
  }
}















// ‚îÄ‚îÄ Funci√≥n para generar formato de calidad EXACTO (nueva pesta√±a) ‚îÄ‚îÄ‚îÄ
async function generarPDFCalidad(ruta, viaje) {
  showToast('‚è≥ Generando vista previa del formato de calidad...');
  
  try {
    const items = allRawItems.filter(it => it.ruta === ruta && it.viaje === viaje);
    const { porAlmacen: sesionPorAlmacen } = await cargarSesionesRuta(ruta, viaje);

    // Determinar tipo de ruta (de la primera sesi√≥n)
    const sesiones = Object.values(sesionPorAlmacen);
    const tipoRuta = sesiones.length > 0 ? sesiones[0].tipo : '';
    
    // Determinar checkboxes de cr√≠tico
    const palabrasCritico = {
      tumbler: ['TUMBLER'],
      vino: ['VINO'],
      vam: ['VAM'],
      grisinnis: ['GRISINNIS'],
      tazas: ['TAZAS'],
      tarjeta: ['TARJETA']
    };

    const criticosMarcados = {
      tumbler: false,
      vino: false,
      vam: false,
      grisinnis: false,
      tazas: false,
      tarjeta: false,
      otros: false,
      sinCritico: true
    };

    items.forEach(item => {
      const texto = `${item.codigo} ${item.desc || ''}`.toUpperCase();
      let encontrado = false;
      
      Object.entries(palabrasCritico).forEach(([key, palabras]) => {
        if (palabras.some(p => texto.includes(p))) {
          criticosMarcados[key] = true;
          criticosMarcados.sinCritico = false;
          encontrado = true;
        }
      });
      
      if (encontrado) {
        criticosMarcados.otros = true;
      }
    });

    // Contar faltantes y sobrantes por almac√©n
    const conteo = {
      SECO: { faltante: 0, sobrante: 0 },
      REFRIGERADO: { faltante: 0, sobrante: 0 },
      FRIO: { faltante: 0, sobrante: 0 },
      CRITICO: { faltante: 0, sobrante: 0 }
    };

    items.forEach(item => {
      const alm = item.alm;
      if (conteo[alm]) {
        if (itemStatus[item.itemId] === 'faltante' || itemStatus[item.itemId] === 'faltante-confirmado') {
          conteo[alm].faltante++;
        }
        if (item.tipo === 'SOBRANTE') {
          conteo[alm].sobrante++;
        }
      }
    });

    const fecha = new Date().toLocaleDateString('es-MX').split('/').map(n => n.padStart(2, '0')).join('/');
    const hora = new Date().toLocaleTimeString('es-MX');

    // Generar HTML completo con estilos para impresi√≥n
    const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Formato de Calidad - Ruta ${ruta}</title>
        <link href="https://fonts.googleapis.com/css2?family=Verdana&display=swap" rel="stylesheet">
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: 'Verdana', Arial, sans-serif; 
            background: white; 
            color: #000; 
            padding: 20px;
            font-size: 10px;
          }
          .container {
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
          }
          table {
            border-collapse: collapse;
            width: 100%;
          }
          td {
            border: 1px solid #000;
            padding: 4px;
            vertical-align: middle;
          }
          .check-box {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            margin-right: 3px;
            background: white;
          }
          .check-box.checked {
            background: #000;
          }
          .bpd-box {
            border: 1px solid #000;
            padding: 5px;
            margin: 10px 0;
          }
          .ruta-box {
            border: 1px solid #000;
            padding: 4px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
          }
          .observaciones-box {
            border: 1px solid #000;
            padding: 4px;
            margin: 10px 0;
            width: 300px;
            margin-left: auto;
          }
          .observaciones-title {
            font-weight: bold;
            margin-bottom: 5px;
          }
          .observaciones-line {
            height: 20px;
            border-bottom: 1px solid #000;
            margin-bottom: 5px;
          }
          .tipo-ruta-box {
            border: 1px solid #000;
            padding: 5px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
          }
          .critico-box {
            border: 1px solid #000;
            padding: 5px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
          }
          .firmas-section {
            margin-top: 30px;
          }
          .firma-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
          }
          .firma-item {
            width: 30%;
            text-align: center;
          }
          .firma-line {
            border-top: 1px solid #000;
            width: 100%;
            margin: 5px 0;
          }
          .operador-box {
            margin-top: 20px;
            text-align: center;
          }
          .operador-line {
            border-top: 1px solid #000;
            width: 50%;
            margin: 5px auto;
          }
          .print-button-container {
            text-align: center;
            margin-bottom: 20px;
          }
          .print-button {
            background: #1a3a5c;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: inline-block;
          }
          .print-button:hover {
            background: #122840;
          }
          
          /* ESTILOS DE IMPRESI√ìN - CORREGIDO */
@media print {
  body { 
    padding: 5px; 
    margin: 0;
    background: white;
    font-size: 7px;
  }
  .no-print { 
    display: none; 
  }
  button { 
    display: none; 
  }
  .print-button { 
    display: none; 
  }
  
  /* NO forzar bordes en todas las tablas - esto causaba el problema */
  table {
    border-collapse: collapse;
  }
  
  /* Forzar color gris en encabezados */
  td[style*="background-color: #D9D9D9"], td[bgcolor="#D9D9D9"] {
    background-color: #D9D9D9 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  /* Para el cuadro de Observaciones - mantener solo bordes perimetrales */
  td[colspan="10"][style*="border-left"] {
    border-left: 1px solid #000 !important;
    border-right: 1px solid #000 !important;
  }
  
  /* Para la primera fila de Observaciones (t√≠tulo) */
  td[colspan="10"][style*="border-top"]:not([style*="border-bottom"]) {
    border-top: 1px solid #000 !important;
    border-bottom: none !important;
    border-left: 1px solid #000 !important;
    border-right: 1px solid #000 !important;
  }
  
  /* Para las filas intermedias de Observaciones (sin bordes horizontales) */
  td[colspan="10"][style*="border-left"][style*="border-right"]:not([style*="border-top"]):not([style*="border-bottom"]) {
    border-top: none !important;
    border-bottom: none !important;
    border-left: 1px solid #000 !important;
    border-right: 1px solid #000 !important;
  }
  
  /* Para la √∫ltima fila de Observaciones */
  td[colspan="10"][style*="border-bottom"]:not([style*="border-top"]) {
    border-bottom: 1px solid #000 !important;
    border-top: none !important;
    border-left: 1px solid #000 !important;
    border-right: 1px solid #000 !important;
  }
  
  /* Para la celda de Ruta (solo borde inferior) */
  td[style*="border-bottom: 1px solid #000"]:not([style*="border-left"]):not([style*="border-right"]):not([style*="border-top"]) {
    border-left: none !important;
    border-right: none !important;
    border-top: none !important;
    border-bottom: 1px solid #000 !important;
  }
  
  /* Para celdas sin borde */
  td[style*="border: none"], td[style*="border:none"] {
    border: none !important;
  }
  
  /* Forzar checkboxes */
  .check-box {
    border: 1px solid #000 !important;
    background-color: white !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  .check-box.checked {
    background-color: #000 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  /* Forzar fondo del logo */
  [style*="position: absolute"] {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    background-color: white !important;
  }
  
  /* Asegurar colores en todos los elementos */
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
}
        </style>
      </head>
      <body>
        <div class="container">
          <div class="no-print print-button-container">
            <button class="print-button" onclick="window.print()">üñ®Ô∏è Imprimir / Guardar PDF</button>
          </div>

          <!-- ENCABEZADO PRINCIPAL - Tabla de 27 columnas x 4 filas -->
          <div style="position: relative; margin-bottom: 20px; width: 100%;">
            <!-- Logo (columna 23-27, filas 1-4) -->
            <div style="position: absolute; top: 0; right: 0; width: 18.5%; height: 100%; border: 1px solid #000; display: flex; align-items: center; justify-content: center; background: white; z-index: 10;">
              <img src="logo.png" alt="Logo" style="max-width: 90%; max-height: 90%;" onerror="this.style.display='none'; this.parentElement.innerHTML='LOGO'">
            </div>

            <!-- Tabla principal de 27 columnas -->
            <table style="width: 100%; border-collapse: collapse; font-family: 'Verdana', sans-serif; font-size: 10px; table-layout: fixed;">
              <!-- Fila 1 - Encabezados -->
              <tr>
                <td colspan="11" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">Nombre del documento</td>
                <td colspan="6" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">C√≥digo del Documento</td>
                <td colspan="5" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">Emisi√≥n</td>
                <td colspan="5" style="border: 1px solid #000; border-left: 1px solid #000; background-color: #D9D9D9;" bgcolor="#D9D9D9"></td>
              </tr>
              
              <!-- Fila 2 - Datos -->
              <tr>
                <td colspan="11" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">FORMATO DE VALIDACI√ìN DE RUTAS</td>
                <td colspan="6" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">FOR-CDS-CYD-CDC-287</td>
                <td colspan="5" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">09/01/26</td>
                <td colspan="5" style="border: 1px solid #000; border-left: 1px solid #000; background-color: white;" bgcolor="white"></td>
              </tr>
              
              <!-- Fila 3 - Encabezados segunda l√≠nea -->
              <tr>
                <td colspan="4" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">Proceso</td>
                <td colspan="4" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">√Årea</td>
                <td colspan="3" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">L√≠nea</td>
                <td colspan="6" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">Versi√≥n</td>
                <td colspan="5" style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px; vertical-align: middle;" bgcolor="#D9D9D9">Pr√≥xima revisi√≥n</td>
                <td colspan="5" style="border: 1px solid #000; border-left: 1px solid #000; background-color: #D9D9D9;" bgcolor="#D9D9D9"></td>
              </tr>
              
              <!-- Fila 4 - Datos segunda l√≠nea -->
              <tr>
                <td colspan="4" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">Finanzas</td>
                <td colspan="4" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">Mesa de Control</td>
                <td colspan="3" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">Almac√©n</td>
                <td colspan="6" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">04</td>
                <td colspan="5" style="border: 1px solid #000; text-align: center; padding: 4px; vertical-align: middle; background-color: white;" bgcolor="white">08/01/29</td>
                <td colspan="5" style="border: 1px solid #000; border-left: 1px solid #000; background-color: white;" bgcolor="white"></td>
              </tr>
            </table>
          </div>

          <!-- DESCRIPCI√ìN BPD's -->
<div style="margin: 5px 0;">
  <div style="font-size: 10px; margin-bottom: 2px;">
    Cumplimiento de los lineamientos de BPD¬¥s : Aplica a todo el personal del √Årea de Validaci√≥n se deber√° colocar si cumple (‚úì),
  </div>
  <div style="font-size: 10px;">
    no cumple (‚úó) o no aplica (N/A). El formato deber√° realizarse cada vez que se inicie una ruta .
  </div>
  <div style="display: flex; gap: 20px; margin-top: 5px; font-size: 10px;">
  </div>
</div>

         <!-- RUTA VALIDADA y OBSERVACIONES (6 filas, 27 columnas) -->
<div style="width: 100%; margin: 5px 0;">

  <!-- Tabla de 27 columnas x 6 filas -->
  <table style="width: 100%; border-collapse: collapse; font-family: 'Verdana', sans-serif; font-size: 10px; table-layout: fixed;">
    
    <!-- FILA 1 - Encabezados de la secci√≥n -->
<tr>
  <!-- Espacio izquierdo (columnas 1-17) vac√≠o -->
  <td colspan="17" style="border: none;"></td>
  <!-- T√≠tulo Observaciones (columnas 18-27) -->
  <td colspan="10" style="border-left: 1px solid #000; border-right: 1px solid #000; border-top: 1px solid #000; border-bottom: none; padding: 4px; font-weight: bold; text-align: center; background-color: #D9D9D9;" bgcolor="#D9D9D9">
    Observaciones
  </td>
</tr>
    
    <!-- FILA 2 -->
    <tr>
      <!-- Espacio izquierdo (columnas 1-17) vac√≠o -->
      <td colspan="17" style="border: none;"></td>
      <!-- Cuadro observaciones fila 2 (solo bordes laterales) -->
      <td colspan="10" style="border-left: 1px solid #000; border-right: 1px solid #000; border-top: none; border-bottom: none; height: 15px;"></td>
    </tr>
    
    <!-- FILA 3 -->
    <tr>
      <!-- Espacio izquierdo (columnas 1-17) vac√≠o -->
      <td colspan="17" style="border: none;"></td>
      <!-- Cuadro observaciones fila 3 (solo bordes laterales) -->
      <td colspan="10" style="border-left: 1px solid #000; border-right: 1px solid #000; border-top: none; border-bottom: none; height: 15px;"></td>
    </tr>
    
    <!-- FILA 4 - Ruta Validada -->
    <tr>
      <!-- Texto "Ruta Validada:" (columnas 1-3) -->
      <td colspan="3" style="border: none; padding: 4px 2px; vertical-align: bottom;">
        <span style="font-size: 10px;">Ruta Validada:</span>
      </td>
      <!-- Valor de la ruta (columnas 4-7) con borde inferior -->
      <td colspan="4" style="border-left: none; border-right: none; border-top: none; border-bottom: 1px solid #000; padding: 4px 2px 0 2px; vertical-align: bottom;">
        <span style="font-size: 12px; font-weight: bold;">${ruta}</span>
      </td>
      <!-- Espacio restante (columnas 8-17) -->
      <td colspan="10" style="border: none;"></td>
      <!-- Cuadro observaciones fila 4 (solo bordes laterales) -->
      <td colspan="10" style="border-left: 1px solid #000; border-right: 1px solid #000; border-top: none; border-bottom: none; height: 15px;"></td>
    </tr>
    
    <!-- FILA 5 -->
    <tr>
      <!-- Espacio izquierdo (columnas 1-17) vac√≠o -->
      <td colspan="17" style="border: none;"></td>
      <!-- Cuadro observaciones fila 5 (solo bordes laterales) -->
      <td colspan="10" style="border-left: 1px solid #000; border-right: 1px solid #000; border-top: none; border-bottom: none; height: 15px;"></td>
    </tr>
    
    <!-- FILA 6 - Cierre del cuadro de observaciones -->
    <tr>
      <!-- Espacio izquierdo (columnas 1-17) vac√≠o -->
      <td colspan="17" style="border: none;"></td>
      <!-- Cuadro observaciones fila 6 (borde inferior) -->
      <td colspan="10" style="border-left: 1px solid #000; border-right: 1px solid #000; border-top: none; border-bottom: 1px solid #000; height: 15px;"></td>
    </tr>
  </table>
</div>

          <!-- TIPO DE RUTA (checkboxes) -->
          <div class="tipo-ruta-box">
            <strong>Tipo de Ruta:</strong>
            <span><span class="check-box ${tipoRuta === 'AEROPUERTO' ? 'checked' : ''}"></span> Aeropuerto</span>
            <span><span class="check-box ${tipoRuta === 'PRECARGA' ? 'checked' : ''}"></span> Precarga</span>
            <span><span class="check-box ${tipoRuta === 'QUINTA' ? 'checked' : ''}"></span> Quinta</span>
            <span><span class="check-box ${tipoRuta === 'NO TOP' ? 'checked' : ''}"></span> Ruta No Top</span>
          </div>

          <!-- CR√çTICO (checkboxes) -->
          <div class="critico-box">
            <strong>Critico:</strong>
            <span><span class="check-box ${criticosMarcados.tumbler ? 'checked' : ''}"></span> Tumbler</span>
            <span><span class="check-box ${criticosMarcados.vino ? 'checked' : ''}"></span> Vino</span>
            <span><span class="check-box ${criticosMarcados.vam ? 'checked' : ''}"></span> Vam</span>
            <span><span class="check-box ${criticosMarcados.grisinnis ? 'checked' : ''}"></span> Grisinnis</span>
            <span><span class="check-box ${criticosMarcados.tazas ? 'checked' : ''}"></span> Tazas</span>
            <span><span class="check-box ${criticosMarcados.tarjeta ? 'checked' : ''}"></span> Tarjeta</span>
            <span><span class="check-box ${criticosMarcados.otros ? 'checked' : ''}"></span> Otros</span>
            <span><span class="check-box ${criticosMarcados.sinCritico ? 'checked' : ''}"></span> Sin Critico</span>
          </div>

          <!-- TABLA PRINCIPAL DE VALIDACI√ìN -->
          <table style="margin: 15px 0;">
            <thead>
              <tr>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Ambiente Validado</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Fecha</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Hora de Inicio</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Hora de Termino</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Nombre del Validador</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">N¬∞ Tarimas</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Anden</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Faltante</th>
                <th style="border: 1px solid #000; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 4px;" bgcolor="#D9D9D9">Sobrante</th>
              </tr>
            </thead>
            <tbody>
              <!-- SECO -->
              <tr>
                <td style="border: 1px solid #000; padding: 4px; font-weight: bold; background-color: white;" bgcolor="white">Seco</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.SECO ? new Date(sesionPorAlmacen.SECO.inicio).toLocaleDateString().split('/').map(n => n.padStart(2,'0')).join('/') : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.SECO ? new Date(sesionPorAlmacen.SECO.inicio).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.SECO && sesionPorAlmacen.SECO.fin ? new Date(sesionPorAlmacen.SECO.fin).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.SECO ? sesionPorAlmacen.SECO.validador : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.SECO ? sesionPorAlmacen.SECO.tarimas : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.SECO ? sesionPorAlmacen.SECO.anden : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.SECO.faltante || ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.SECO.sobrante || ''}</td>
              </tr>
              <!-- REFRIGERADO -->
              <tr>
                <td style="border: 1px solid #000; padding: 4px; font-weight: bold; background-color: white;" bgcolor="white">Refrigerado</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.REFRIGERADO ? new Date(sesionPorAlmacen.REFRIGERADO.inicio).toLocaleDateString().split('/').map(n => n.padStart(2,'0')).join('/') : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.REFRIGERADO ? new Date(sesionPorAlmacen.REFRIGERADO.inicio).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.REFRIGERADO && sesionPorAlmacen.REFRIGERADO.fin ? new Date(sesionPorAlmacen.REFRIGERADO.fin).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.REFRIGERADO ? sesionPorAlmacen.REFRIGERADO.validador : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.REFRIGERADO ? sesionPorAlmacen.REFRIGERADO.tarimas : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.REFRIGERADO ? sesionPorAlmacen.REFRIGERADO.anden : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.REFRIGERADO.faltante || ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.REFRIGERADO.sobrante || ''}</td>
              </tr>
              <!-- CONGE (Congelado) -->
              <tr>
                <td style="border: 1px solid #000; padding: 4px; font-weight: bold; background-color: white;" bgcolor="white">Conge</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.FRIO ? new Date(sesionPorAlmacen.FRIO.inicio).toLocaleDateString().split('/').map(n => n.padStart(2,'0')).join('/') : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.FRIO ? new Date(sesionPorAlmacen.FRIO.inicio).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.FRIO && sesionPorAlmacen.FRIO.fin ? new Date(sesionPorAlmacen.FRIO.fin).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.FRIO ? sesionPorAlmacen.FRIO.validador : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.FRIO ? sesionPorAlmacen.FRIO.tarimas : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.FRIO ? sesionPorAlmacen.FRIO.anden : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.FRIO.faltante || ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.FRIO.sobrante || ''}</td>
              </tr>
              <!-- CR√çTICO -->
              <tr>
                <td style="border: 1px solid #000; padding: 4px; font-weight: bold; background-color: white;" bgcolor="white">Cr√≠tico</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.CRITICO ? new Date(sesionPorAlmacen.CRITICO.inicio).toLocaleDateString().split('/').map(n => n.padStart(2,'0')).join('/') : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.CRITICO ? new Date(sesionPorAlmacen.CRITICO.inicio).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.CRITICO && sesionPorAlmacen.CRITICO.fin ? new Date(sesionPorAlmacen.CRITICO.fin).toLocaleTimeString() : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.CRITICO ? sesionPorAlmacen.CRITICO.validador : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.CRITICO ? sesionPorAlmacen.CRITICO.tarimas : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; background-color: white;" bgcolor="white">${sesionPorAlmacen.CRITICO ? sesionPorAlmacen.CRITICO.anden : ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.CRITICO.faltante || ''}</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center; background-color: white;" bgcolor="white">${conteo.CRITICO.sobrante || ''}</td>
              </tr>
            </tbody>
          </table>

          <!-- 6 FILAS ANTES DE FIRMAS -->
          <div style="height: 60px;"></div>

          <!-- SECCI√ìN DE FIRMAS TEAM (3) -->
<div class="firmas-section">
  <div class="firma-row">
    <div class="firma-item">
      <div class="firma-line"></div>
      <strong>Firma del TEAM</strong>
    </div>
    <div class="firma-item">
      <div class="firma-line"></div>
      <strong>Firma del TEAM</strong>
    </div>
    <div class="firma-item">
      <div class="firma-line"></div>
      <strong>Firma del TEAM</strong>
    </div>
  </div>

  <!-- 3 FILAS ANTES DE OPERADOR -->
  <div style="height: 10px;"></div>

  <!-- NOMBRE Y FIRMA DE OPERADOR MANIOBRA -->
  <div class="operador-box">
    <div class="operador-line"></div>
    <strong>Nombre y Firma de Operador Maniobra</strong>
  </div>

  <!-- LEYENDA DE COPIA NO CONTROLADA -->
  <div style="margin-top: 10px; font-size: 6.5px; text-align: center; border-top: 1px solid #000; padding-top: 3px;">
    Las copias impresas de este documento son consideradas COPIA NO CONTROLADA, a menos que cuenten con un sello de DOCUMENTO CONTROLADO.
  </div>
</div>
          </div>
        </div>
      </body>
      </html>
    `;

    // Abrir nueva pesta√±a con el contenido
    const ventana = window.open('', '_blank');
    ventana.document.write(htmlContent);
    ventana.document.close();
    
    showToast('‚úÖ Vista previa del formato de calidad abierta');
  } catch (error) {
    console.error('Error generando formato:', error);
    showToast('‚ùå Error al generar formato');
  }
}


  // ‚îÄ‚îÄ Listen Firestore realtime ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function listenFirestore() {
    onSnapshot(query(collection(db, 'rutas'), orderBy('cargadoEn', 'desc')), snap => {
      const map = {};
      snap.forEach(d => {
        const data = d.data();
        const key = `${data.ruta}||${data.viaje}`;
        if (!map[key]) map[key] = { ruta: data.ruta, viaje: data.viaje, almacenes: data.almacenes || [] };
      });
      allRoutes = Object.values(map);
      recalcRouteAlmStatus();
      renderTable();
    });

    onSnapshot(collection(db, 'items'), snap => {
      snap.docChanges().forEach(change => {
        const data = change.doc.data();
        const itemId = change.doc.id;

        if (change.type === 'removed') {
          const index = allRawItems.findIndex(it => it.itemId === itemId);
          if (index >= 0) {
            allRawItems.splice(index, 1);
          }
          delete itemStatus[itemId];
        } else {
          itemStatus[itemId] = data.estatus || 'pendiente';

          const existingIndex = allRawItems.findIndex(it => it.itemId === itemId);
          const newItem = {
            itemId: itemId,
            ruta: data.ruta,
            viaje: data.viaje,
            codigo: data.codigo,
            desc: data.descripcion,
            udm: data.udm,
            sdo: data.sdo,
            alm: data.almacen
          };

          if (existingIndex >= 0) {
            allRawItems[existingIndex] = newItem;
          } else {
            allRawItems.push(newItem);
          }
        }
      });

      recalcRouteAlmStatus();
      renderTable();
    });

    // Escuchar sesiones de validaci√≥n
    onSnapshot(collection(db, 'sesiones_validacion'), snap => {
      // Limpiar cach√© cuando hay cambios
      sesionesPorRuta = {};
      if (currentModalKey) {
        const [ruta, viaje] = currentModalKey.split('||');
        const route = allRoutes.find(r => r.ruta === ruta && r.viaje === viaje);
        if (route) renderModal(route);
      }
    });
  }

  // ‚îÄ‚îÄ Search / filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  searchInput.addEventListener('input', renderTable);
  function getFiltered() {
    const q = searchInput.value.toLowerCase();
    if (!q) return allRoutes;
    return allRoutes.filter(r => r.ruta.toLowerCase().includes(q) || r.viaje.toLowerCase().includes(q));
  }

  // ‚îÄ‚îÄ Calc % per route ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcRoutePct(route) {
    const items = allRawItems.filter(it => it.ruta === route.ruta && it.viaje === route.viaje);
    if (!items.length) return 0;
    const done = items.filter(it => 
      itemStatus[it.itemId] === 'concluido' || 
      itemStatus[it.itemId] === 'faltante-confirmado'
    ).length;
    return Math.round(done / items.length * 100);
  }

  // ‚îÄ‚îÄ Check if route is complete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function rutaEstaCompleta(route) {
    const items = allRawItems.filter(it => it.ruta === route.ruta && it.viaje === route.viaje);
    if (items.length === 0) return false;
    return items.every(it => 
      itemStatus[it.itemId] === 'concluido' || 
      itemStatus[it.itemId] === 'faltante-confirmado'
    );
  }

  // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateStats(routes) {
    let validadas = 0, tItems = 0, vItems = 0;
    routes.forEach(r => {
      const items = allRawItems.filter(it => it.ruta === r.ruta && it.viaje === r.viaje);
      const done = items.filter(it => 
        itemStatus[it.itemId] === 'concluido' || 
        itemStatus[it.itemId] === 'faltante-confirmado'
      ).length;
      tItems += items.length;
      vItems += done;
      if (items.length && done === items.length) validadas++;
    });
    document.getElementById('statTotal').textContent = routes.length;
    document.getElementById('statValidadas').textContent = validadas;
    document.getElementById('statPendientes').textContent = routes.length - validadas;
    document.getElementById('statProgreso').textContent = tItems ? `${Math.round(vItems / tItems * 100)}%` : '0%';
  }

  // ‚îÄ‚îÄ Render main table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const TYPES = ['SECO', 'REFRIGERADO', 'CONGELADO', 'CRITICO'];

  function renderTable() {
    const routes = getFiltered();
    const tbody = document.getElementById('tableBody');
    const empty = document.getElementById('emptyState');

    if (!allRoutes.length) {
      tbody.innerHTML = '';
      empty.style.display = 'flex';
      return;
    }
    empty.style.display = 'none';
    updateStats(routes);

    if (!routes.length) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--faint);">Sin resultados</td></tr>`;
      return;
    }

    tbody.innerHTML = routes.map((r, i) => {
      const pct = calcRoutePct(r);
      const barColor = pct === 100 ? 'var(--green)' : pct > 0 ? 'var(--orange)' : 'var(--border)';
      const pctColor = pct === 100 ? 'var(--green)' : pct > 0 ? 'var(--orange)' : 'var(--faint)';
      const completa = rutaEstaCompleta(r);

      const cols = TYPES.map(type => {
        const almacenType = type === 'CONGELADO' ? 'FRIO' : type;
        if (!r.almacenes.includes(almacenType)) return `<td><span class="chip na">N/A</span></td>`;
        const st = routeAlmStatus[`${r.ruta}||${r.viaje}||${almacenType}`] || 'pendiente';
        let chipClass = st;
        if (st === 'faltante-confirmado') chipClass = 'faltante-confirmado';
        return `<td><span class="chip ${chipClass}">${st === 'faltante-confirmado' ? 'faltante confirmado' : st}</span></td>`;
      }).join('');

      return `<tr>
        <td>
          <span class="ruta-badge">${r.ruta}</span>
          <span class="viaje-text">${r.viaje}</span>
          <div class="action-icons">
            <span class="click-hint" onclick="openModal('${r.ruta}', '${r.viaje}')">‚ñ∏ ver detalle</span>
            ${completa ? `
              <span class="pdf-icon red" onclick="generarPDFProductos('${r.ruta}', '${r.viaje}')" title="Descargar lista de productos">üìÑ</span>
              <span class="pdf-icon blue" onclick="generarPDFCalidad('${r.ruta}', '${r.viaje}')" title="Descargar formato de calidad">üìã</span>
            ` : ''}
          </div>
        </td>
        <td class="progress-cell">
          <div class="progress-wrap">
            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%;background:${barColor}"></div></div>
            <span class="progress-pct" style="color:${pctColor}">${pct}%</span>
          </div>
        </td>
        ${cols}
        <td>
          <button class="delete-btn" onclick="deleteRoute('${r.ruta}', '${r.viaje}')">
            ‚ùå
          </button>
        </td>
      </tr>`;
    }).join('');

    // Hacer funciones globales
    window.openModal = (ruta, viaje) => {
      const route = allRoutes.find(r => r.ruta === ruta && r.viaje === viaje);
      if (route) openModal(route);
    };

    window.deleteRoute = (ruta, viaje) => {
      deleteRoute(ruta, viaje);
    };

    window.generarPDFProductos = (ruta, viaje) => {
      generarPDFProductos(ruta, viaje);
    };

    window.generarPDFCalidad = (ruta, viaje) => {
      generarPDFCalidad(ruta, viaje);
    };
  }

  // ‚îÄ‚îÄ Modal con datos de validaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function openModal(route) {
    currentModalKey = `${route.ruta}||${route.viaje}`;
    await renderModal(route);
    modalOverlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modalOverlay.classList.remove('show');
    document.body.style.overflow = '';
    currentModalKey = null;
  }

  modalClose.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });

  async function renderModal(route) {
    document.getElementById('modalTitle').textContent = `Ruta ${route.ruta}`;
    document.getElementById('modalMeta').textContent = `Viaje: ${route.viaje}`;

    const items = allRawItems.filter(it => it.ruta === route.ruta && it.viaje === route.viaje);
    const { porAlmacen: sesionPorAlmacen, todas: sesiones } = await cargarSesionesRuta(route.ruta, route.viaje);

    const done = items.filter(it => 
      itemStatus[it.itemId] === 'concluido' || 
      itemStatus[it.itemId] === 'faltante-confirmado'
    ).length;
    const pct = items.length ? Math.round(done / items.length * 100) : 0;
    const barColor = pct === 100 ? 'var(--green)' : pct > 0 ? 'var(--orange)' : 'var(--border)';

    document.getElementById('modalPctBar').style.width = `${pct}%`;
    document.getElementById('modalPctBar').style.background = barColor;
    document.getElementById('modalPctVal').textContent = `${pct}%`;
    document.getElementById('modalPctVal').style.color = pct === 100 ? 'var(--green)' : pct > 0 ? 'var(--orange)' : 'var(--muted)';

    // Info de validaci√≥n
    const sesionInfo = sesiones.length > 0 ? sesiones[0] : null;
    const tiempoTotal = sesiones.length > 0 && sesiones[0].inicio && sesiones[0].fin ? 
      calcularTiempoTranscurrido(sesiones[0].inicio, sesiones[0].fin) : 'N/A';

    const validacionHTML = `
      <div class="validacion-info">
        <div class="info-item">
          <span class="info-label">Hora de Inicio</span>
          <span class="info-value">${sesionInfo?.inicio ? new Date(sesionInfo.inicio).toLocaleTimeString() : 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Hora de Fin</span>
          <span class="info-value">${sesionInfo?.fin ? new Date(sesionInfo.fin).toLocaleTimeString() : 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Tiempo Transcurrido</span>
          <span class="info-value">${tiempoTotal}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Validador</span>
          <span class="info-value">${sesionInfo?.validador || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Tarimas</span>
          <span class="info-value">${sesionInfo?.tarimas || '0'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Anden</span>
          <span class="info-value">${sesionInfo?.anden || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Tipo de Ruta</span>
          <span class="info-value">${sesionInfo?.tipo || 'N/A'}</span>
        </div>
      </div>
    `;

    // Group by almacen
    const byAlm = {};
    items.forEach(it => {
      const almDisplay = it.alm === 'FRIO' ? 'CONGELADO' : it.alm;
      if (!byAlm[almDisplay]) byAlm[almDisplay] = [];
      byAlm[almDisplay].push(it);
    });

    const ALM_ORDER = ['SECO', 'REFRIGERADO', 'CONGELADO', 'CRITICO'];
    const almKeys = [...ALM_ORDER.filter(a => byAlm[a]), ...Object.keys(byAlm).filter(a => !ALM_ORDER.includes(a))];

    const ALM_COLORS = {
      SECO: '#1a3a5c',
      REFRIGERADO: '#6b48c8',
      CONGELADO: '#0e7c7c',
      CRITICO: '#8e1e1e'
    };

    const almacenesHTML = almKeys.map(alm => {
      const almItems = byAlm[alm];
      const almDone = almItems.filter(it => 
        itemStatus[it.itemId] === 'concluido' || 
        itemStatus[it.itemId] === 'faltante-confirmado'
      ).length;
      const color = ALM_COLORS[alm] || 'var(--navy)';

      const rows = almItems.map(it => {
        const st = itemStatus[it.itemId] || 'pendiente';
        const mostrarBoton = st === 'faltante';
        
        let textoEstatus = st;
        if (st === 'faltante-confirmado') {
          textoEstatus = 'faltante confirmado';
        }
        
        let badgeClass = st;
        if (st === 'faltante-confirmado') badgeClass = 'faltante-confirmado';

        return `<tr>
          <td><span class="codigo-badge">${it.codigo}</span></td>
          <td><span class="desc-text" title="${it.desc}">${it.desc}</span></td>
          <td><span class="udm-text">${it.udm}</span></td>
          <td><span class="sdo-text">${it.sdo}</span></td>
          <td>
            <span class="status-badge ${badgeClass}">${textoEstatus}</span>
            ${mostrarBoton ? `<button class="btn-confirmar" onclick="confirmarFaltante('${it.itemId}')">‚úì Confirmar Faltante</button>` : ''}
          </td>
        </tr>`;
      }).join('');

      return `<div class="alm-section">
        <div class="alm-header">
          <div class="alm-name"><span class="alm-dot" style="background:${color}"></span>${alm}</div>
          <span class="alm-count">${almDone}/${almItems.length} concluidos</span>
        </div>
        <div class="alm-table-wrap">
          <table class="alm-table">
            <thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>UDM</th><th>SDO</th><th>Estatus</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>`;
    }).join('');

    document.getElementById('modalBody').innerHTML = validacionHTML + almacenesHTML;

    window.confirmarFaltante = (itemId) => {
      confirmarFaltante(itemId);
    };
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  await loadKnownTLs();
  listenFirestore();
  renderTable();
</script>
</body>
</html>
